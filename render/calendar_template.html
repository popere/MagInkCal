<html>
  <head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="bootstrap.min.css" />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="container p-0 m-0">
      <!-- Calendar -->
      <div class="calendar shadow bg-white p-3">
        <!-- Last ip -->
        <div class="text-right last-ip">$lastIp</div>
        <!-- Weather -->
        <div>$weather</div>
        <!-- Month -->
        <div class="align-items-center text-center">
          <h3 class="month font-weight-bold mb-0 text-uppercase">$month</h3>
        </div>
        <!-- Battery -->
        <div class="batt_container">
          <img class="$battText" src="battery.png" />
        </div>
        <!-- Days of week -->
        <ol class="day-names list-unstyled text-center">
          $dayOfWeek
        </ol>
        <!-- Calendar and events -->
        <div>$events</div>
      </div>
    </div>
    <script>
      const rainDataToday = [$rainDataToday];
      const rainDataTomorrow = [$rainDataTomorrow];
      const rainDataAfter = [$rainDataAfter];

      const HOURS_MARKS_WIDTH_TEXT = [3, 8, 12, 17, 22];
      const hoursMarks = [];
      for (var i = 0; i < 24; i++) {
        hoursMarks.push(i);
      }

      function renderChart(containerId, xId, data) {
        const max = Math.max.apply(null, data) || 1;
        const chart = document.getElementById(containerId);
        const xAxis = document.getElementById(xId);
        const currentHour = new Date().getHours();
        const barCount = data.length;
        const barWidthPercent = 100 / barCount;

        // Barras
        for (var i = 0; i < data.length; i++) {
          const mm = data[i];
          const bar = document.createElement("div");
          bar.className = "bar";
          if (i === currentHour && containerId.indexOf("rainToday") !== -1) {
            bar.className += " current-hour";
          }
          bar.style.height = (mm / max) * 100 + "%";
          chart.appendChild(bar);
        }

        // Ticks sin texto
        for (var j = 0; j < hoursMarks.length; j++) {
          const h = hoursMarks[j];
          if (HOURS_MARKS_WIDTH_TEXT.indexOf(h) !== -1) continue;
          const tick = document.createElement("div");
          tick.className = "tick";
          tick.style.left = h * barWidthPercent + barWidthPercent / 2 + "%";
          xAxis.appendChild(tick);
        }

        // Ticks con texto
        for (var k = 0; k < HOURS_MARKS_WIDTH_TEXT.length; k++) {
          const h = HOURS_MARKS_WIDTH_TEXT[k];
          const tick = document.createElement("div");
          tick.className = "tick width-text";
          tick.style.left = h * barWidthPercent + barWidthPercent / 2 + "%";
          if (
            containerId.indexOf("rainToday") === -1 ||
            Math.abs(h - currentHour) > 3
          ) {
            tick.textContent = h + " h";
          }
          xAxis.appendChild(tick);
        }

        // Hora actual solo para hoy
        if (containerId.indexOf("rainToday") !== -1) {
          const tick = document.createElement("div");
          tick.className = "tick current-hour";
          tick.style.left =
            currentHour * barWidthPercent + barWidthPercent / 2 + "%";
          tick.textContent = currentHour + " h";
          xAxis.appendChild(tick);
        }
      }

      // Llamar a renderChart con bucles cl√°sicos
      for (var i = 0; i < rainDataToday.length; i++) {
        renderChart("rainToday-" + i, "xToday-" + i, rainDataToday[i]);
      }
      for (var i = 0; i < rainDataTomorrow.length; i++) {
        renderChart("rainTomorrow-" + i, "xTomorrow-" + i, rainDataTomorrow[i]);
      }
      for (var i = 0; i < rainDataAfter.length; i++) {
        renderChart("rainAfter-" + i, "xAfter-" + i, rainDataAfter[i]);
      }

      window.status = "ready";
    </script>
  </body>
</html>
